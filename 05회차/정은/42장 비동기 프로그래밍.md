# 42장 비동기 프로그래밍

## 42.1  동기 처리와 비동기 처리

#### 함수 실행 과정
1. 함수 호출
2. 함수 코드 평가 _[참고] 23.2절 소스코드의 평가와 실행_
3. 함수 실행 컨텍스트 생성 _[참고] 23장 실행 컨텍스트_
4. 함수 실행 컨텍스트를 실행 컨텍스트 스택(콜 스택)에 푸시 =  함수 실행의 시작
5. 함수 코드 실행
6. 함수 코드 실행 종료
7.  함수 실행 컨텍스트는 실행 컨텍스트 스택에서 팝되어 제거 

- 함수의 실행 순서는 실행 컨텍스트 스택으로 관리
- 함수가 호출된 순서대로 실행 컨텍스트 스택에 푸시해서 순차적으로 실행됨

#### 싱글 스레드
>  자바스크립트 엔진은 단 하나의 태스크만 실행
- 실행 컨텍스트 스택은 단 하나
- 동시에 2개 이상의 함수를 실행 X

#### 태스크
> 실행 컨텍스트 스택의 최상위 요소인, `실행 중인 실행 컨텍스트`를 제외한 모든 컨텍스트
- 현재 실행 중인 실행 컨텍스트가 팝되어 실행 컨텍스트 스택에서 제거되어야 태스크가 실행됨

#### 블로킹
> 처리에 시간이 걸리는 태스크를 실행할 경우 발생하는 작업 중단

#### 동기 synchronous 처리
> 현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식
- 장점 : 실행 순서가 보장됨
- 단점 : 태스크가 종료될 때까지 이후 태스크들이 블로킹됨
```js
function sleep(func, delay) {
	const delayUntil = Date.now() + delay;
	while(Date.now() < delayUntil);
	func();
}
function foo() {
	console.log('foo');
}
function bar() {
	console.log('bar');
}
sleep( foo, 3 * 1000);
bar(); // 동기 실행 : 3초간 블로킹 후 실행
```
#### 비동기 처리
> 현재 실행 중인 태스크가 종료되지 않은 상태라 해도 다음 태스크를 곧바로 실행
- 장점 : 블로킹 발생 X
- 단점 : 태스크의 실행 순서 보장 X
- 타이머 함수인 `setTimeout`, `setInterval`, `HTTP 요청`, `이벤트 핸들러`는 비동기 처리 방식으로 동작
- 전통적으로 콜백 패턴을 사용하지만 콜백 패턴은 한계가 있음

#### 콜백 패턴의 한계
- 콜백 지옥 발생
- 가독성 나쁨
- 비동기 중 발생한 에러의 예외 처리가 곤란
- 여러 개의 비동기 처리를 한 방에 처리하는 데에도 한계
_[참고] 45절 프로미스_

setTimeout _[참고] 41장 타이머_
```js

function foo() {
	console.log('foo');
}
function bar() {
	console.log('bar');
}
setTimeout(foo, 3*1000); // 비동기 실행 // bar  블로킹 X, 3초 후 foo 호출
bar();
```
## 42.2 이벤트 루프와 태스크 큐
자바스크립트는 싱글 스레드지만, 브라우저는 많은 일을 동시에 처리하는 것처럼 보임

#### 이벤트 루프
> 브라우저에 내장되어있는 기능. 자바스크립트의 동시성 지원

자바 스크립트 엔진은 크게 2개의 영역으로 구분됨
#### 콜 스택
- 소스 코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 자료 구조
- 함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 순차적으로 실행됨
- 자바스크립트는 단 하나의 콜 스택만 가짐
- 최상위 실행 컨텍스트(실행 중인 실행 컨텍스트)가 종료되어 콜 스택에서 제거되기 전까지는 다른 태스크 실행 X
  
_[참고] 23장 실행 컨텍스트_

#### 힙
- 객체가 저장되는 메모리 공간
- 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조함
- 객체는 원시 값과는 달리 크기가 정해져있지 않으므로 메모리를 동적 할당함
- 구조화되어있지 않음

자바스크립트 엔진은 단순히 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행

비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리 ->자바스크립트 엔진 구동 환경(브라우저 또는  Node.js) 담당

####  태스크 큐
- setTimeout이나 setInterval과 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역
- 태스크 큐와 별도로 프로미스의 후속  처리 메서드의 콜백 함수가 일시적으로 보관되는 마이크로태스크 큐도 존재
  
_[참고] 45.7절 마이크로태스크 큐_

#### 이벤트 루프
- 콜 스택에 현재 실행 중인 실행 컨텍스트가 있는지, 태스크 큐에 대기중인 콜백 함수, 이벤트 핸들러 등이 있는지 반복 확인
- 콜 스택이 비어 있고 태스크 큐에 대기 중인 함수가 있다면, 이벤트 루프는 FIFO로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동
- 태스크 큐에 일시 보관된 함수들은 비동기 처리 방식으로 동작


```js

function foo() {
	console.log('foo');
}
function bar() {
	console.log('bar');
}
setTimeout(foo, 0); // 최소 지연 시간 4ms 이후 동작
bar();
```
- 시간을 0으로 설정해도 브라우저가 최소 지연 시간 4ms 이후 콜백 함수 foo가 태스크 큐에 푸시되어 대기
- 콜 스택이 비면 = 전역 코드 및 명시적으로 호출된 함수가 모두 종료되면 콜스택에 푸시되어 실행
- 자바스크립트 엔진은 싱글 스레드지만, 브라우저는 멀티 스레드로 동작
- 브라우저에는 자바스크립트 엔진 외에도 렌더링 엔진과 Web API 제공
	 - Web API는 DOM API와 타이머 함수, HTTP 요청과 비동기 처리 포함
	 - setTimeout은 WebAPI로, 타이머 설정과 태스크 큐 등록 처리는 브라우저가 실행
